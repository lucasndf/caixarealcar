<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Real Car - Sistema de Caixa</title>
<style>
  :root{
    --fundo:#111; --painel:#1d1d1d; --borda:#363636; --campo:#262626;
    --vermelho:#d62828; --texto:#f8f9fa; --ok:#6ee7a8; --bad:#fca5a5; --warn:#facc15;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--fundo);color:var(--texto);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}

  /* Login */
  .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:16px}
  .login-box{background:var(--painel);padding:28px;border-radius:12px;box-shadow:0 0 12px #000;width:340px;max-width:100%;text-align:center;border:1px solid var(--borda)}
  .login-box h1{margin:0 0 6px;color:var(--vermelho)}
  .login-box p{margin:0 0 18px;color:#bbb}
  .login-box input{width:100%;padding:10px;margin-bottom:12px;border:1px solid #4a4a4a;border-radius:6px;background:#222;color:#fff}
  .login-box button{width:100%;padding:11px;background:var(--vermelho);color:#fff;border:none;border-radius:6px;font-weight:700;cursor:pointer}
  .erro{color:#f87171;margin-top:8px;min-height:20px}
  .muted{color:#aaa;font-size:12px;margin-top:6px;line-height:1.35}

  /* App */
  .container{display:none;max-width:1200px;margin:auto;padding:26px 18px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .topbar .actions{display:flex;gap:10px;align-items:center}
  .role-badge{font-size:12px;padding:6px 10px;border:1px solid var(--borda);border-radius:999px;background:#141414;color:#ccc}

  .bloco{background:var(--painel);border-radius:12px;padding:22px;margin-bottom:24px;box-shadow:0 0 10px #00000066;border:1px solid var(--borda)}
  .bloco h2{margin:0 0 12px;color:var(--vermelho);border-bottom:1px solid var(--borda);padding-bottom:8px}
  label{display:block;margin-top:10px;font-weight:600}
  input,select{width:100%;padding:10px;border-radius:6px;border:1px solid #444;background:var(--campo);color:#fff;font-size:15px}
  input[disabled], select[disabled]{opacity:.65; cursor:not-allowed;}
  .form-grid{display:flex;gap:14px;flex-wrap:wrap}
  .form-grid>div{flex:1;min-width:220px}
  button{padding:10px 14px;border:none;border-radius:6px;background:var(--vermelho);color:#fff;font-weight:700;cursor:pointer}
  .secondary{background:#3c3c3c}
  .danger{background:#7a0b0b}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}

  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:9px;border-bottom:1px solid #2f2f2f;font-size:14px;text-align:left;vertical-align:top}
  th{color:#d0d0d0}
  .nowrap{white-space:nowrap}

  .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .pill{flex:1;min-width:160px;background:#0f0f0f;border-radius:10px;padding:10px 12px;text-align:center;border:1px solid var(--borda)}
  .pill b{display:block;color:#bbb;margin-bottom:4px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .neutral{color:var(--warn)}
  .hint{color:#bdbdbd;font-size:12px;margin-top:6px;line-height:1.35}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#333;font-size:12px;margin-left:6px}

  /* Extras (toggle) */
  .extras-head{display:flex;gap:10px;align-items:center;margin-top:8px}
  .extras-head .note{font-size:12px;color:#c6c6c6}
  .extras-box{display:none;margin-top:12px;padding:12px;border-radius:10px;background:#151515;border:1px solid var(--borda)}
  .extras-row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  #tabelaExtras td{vertical-align:middle}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:#000a;display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:var(--painel);border:1px solid var(--borda);border-radius:12px;max-width:800px;width:95%;padding:16px}
  .modal h3{margin:0 0 12px;color:var(--vermelho)}
  .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

  /* mobile: tabela em cards */
  @media (max-width: 768px) {
    .form-grid { flex-direction: column; }
    table, thead, tbody, th, td, tr { display: block; width: 100%; }
    thead tr { display: none; }
    tr { margin-bottom: 15px; border:1px solid var(--borda); border-radius:10px; overflow:hidden; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before { position: absolute; left: 10px; top: 10px; white-space: nowrap; color: #ccc; font-weight: bold; }
    /* Entradas: Data, Cliente, Itens, Instala√ß√£o, Pagamento, Valor, A√ß√µes */
    #tabelaEntradas td:nth-child(1)::before { content: "Data"; }
    #tabelaEntradas td:nth-child(2)::before { content: "Cliente"; }
    #tabelaEntradas td:nth-child(3)::before { content: "Itens"; }
    #tabelaEntradas td:nth-child(4)::before { content: "Instala√ß√£o"; }
    #tabelaEntradas td:nth-child(5)::before { content: "Pagamento"; }
    #tabelaEntradas td:nth-child(6)::before { content: "Valor"; }
    #tabelaEntradas td:nth-child(7)::before { content: "A√ß√µes"; }
    /* Sa√≠das: Data, Descri√ß√£o, Categoria, Valor, A√ß√µes */
    #tabelaSaidas td:nth-child(1)::before { content: "Data"; }
    #tabelaSaidas td:nth-child(2)::before { content: "Descri√ß√£o"; }
    #tabelaSaidas td:nth-child(3)::before { content: "Categoria"; }
    #tabelaSaidas td:nth-child(4)::before { content: "Valor"; }
    #tabelaSaidas td:nth-child(5)::before { content: "A√ß√µes"; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginTela" class="login-container">
  <form id="loginForm" class="login-box">
    <h1>Real Car</h1>
    <p>Sistema de Caixa</p>
    <input id="email" type="email" placeholder="E-mail" autocomplete="username" required>
    <input id="senha" type="password" placeholder="Senha" autocomplete="current-password" required>
    <button id="btnEntrar" type="submit">Entrar</button>
    <div id="erroLogin" class="erro"></div>
    <div class="muted">Pressione <b>Enter</b> para entrar</div>
  </form>
</div>

<!-- APP -->
<div id="app" class="container" aria-hidden="true">
  <div class="topbar">
    <h2 style="margin:0">üìä Caixa</h2>
    <div class="actions">
      <span id="whoami" class="role-badge">‚Äì</span>
      <button id="btnSair" class="secondary" type="button">Sair</button>
    </div>
  </div>

  <!-- Entradas -->
  <div class="bloco" id="blocoEntradas">
    <h2>Entradas <span class="tag"></span></h2>

    <div class="form-grid">
      <div>
        <label>Data</label>
        <input id="dataEntrada" type="date"/>
      </div>

      <div>
        <label>Descri√ß√£o</label>
        <input id="clienteEntrada" type="text" placeholder="Ex.: HB20">
        <div class="hint">Use <b>EX: NOME DA ENTRADA</b>.</div>
      </div>

      <div>
        <label>Tipo</label>
        <select id="tipoEntrada">
          <option>Dianteiro</option>
          <option>Traseiro</option>
          <option>Dianteiro + Servi√ßo</option>
          <option>Traseiro + Servi√ßo</option>
          <option>Dianteiro + Traseiro</option>
          <option>Dianteiro + Traseiro + Servi√ßo</option>
          <option>Amortecedor Central</option>
          <option>Servi√ßo</option>
          <option>Ferro Velho</option>
          <option>Hastes</option>
          <option>Oficina</option>
        </select>
      </div>

      <div id="divServico" style="display:none">
        <label>Descri√ß√£o do Servi√ßo</label>
        <input id="descricaoServico" type="text" placeholder="Ex.: TROCA DE COXIM, BATEDOR..."/>
      </div>

      <div id="instalacaoBox">
        <label>Instala√ß√£o</label>
        <select id="instalacaoEntrada">
          <option>Instalado na Oficina</option>
          <option>Amortecedor Fora</option>
        </select>
      </div>

      <div>
        <label>Qtd</label>
        <input id="qtdEntrada" type="number" value="1" min="1">
      </div>
    </div>

    <!-- Extras (toggle) -->
    <div class="extras-head">
      <button class="secondary" id="toggleExtras" type="button">+ Itens Extras (opcional)</button>
      <span class="note">Use apenas quando o cliente levar mais de um item.</span>
    </div>
    <div class="extras-box" id="extrasBox">
      <div class="extras-row">
        <div style="flex:2;min-width:200px">
          <label>Tipo</label>
          <select id="exTipo">
            <option>Dianteiro</option>
            <option>Traseiro</option>
            <option>Dianteiro + Servi√ßo</option>
            <option>Traseiro + Servi√ßo</option>
            <option>Dianteiro + Traseiro</option>
            <option>Amortecedor Central</option>
            <option>Servi√ßo</option>
            <option>Ferro Velho</option>
            <option>Hastes</option>
            <option>Oficina</option>
          </select>
        </div>
        <div style="flex:1;min-width:120px">
          <label>Qtd</label>
          <input id="exQtd" type="number" min="1" value="1">
        </div>
        <div style="flex:2;min-width:180px">
          <label>Descri√ß√£o</label>
          <input id="exObs" type="text" placeholder="Ex.: HB20">
        </div>
        <div style="flex:3;min-width:240px" id="exDescBox" hidden>
          <label>Descri√ß√£o do Servi√ßo</label>
          <input id="exDesc" type="text" placeholder="Ex.: TROCA DE COXIM, BATEDOR...">
        </div>
        <div>
          <button id="btnAddExtra" type="button">+ Adicionar</button>
        </div>
      </div>
      <table id="tabelaExtras">
        <thead><tr><th>Tipo</th><th>Qtd</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pagamento -->
    <div class="form-grid" style="margin-top:6px">
      <div>
        <label>Forma de Pagamento</label>
        <select id="formaPagamento">
          <option>Pix</option>
          <option>Dinheiro</option>
          <option>Cart√£o</option>
          <option>Combinado</option>
        </select>
      </div>

      <!-- Valor √∫nico (quando N√ÉO √© Combinado) -->
      <div id="boxValorUnico">
        <label>Valor Total (R$)</label>
        <input id="valorEntrada" type="number" step="0.01" placeholder="0,00">
      </div>

      <!-- Pagamento Combinado -->
      <div id="boxCombinado" style="display:none;flex-basis:100%">
        <label>Pagamentos (somar at√© o total desejado)</label>
        <div class="pay-row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Pix</span>
            <input id="payPixVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Dinheiro</span>
            <input id="payDinVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
          <div class="pay-item" style="display:flex;gap:6px;align-items:center;border:1px solid var(--borda);border-radius:8px;padding:6px 8px;background:#141414">
            <span>Cart√£o</span>
            <input id="payCartaoVal" type="number" step="0.01" placeholder="0,00" style="width:120px">
          </div>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <button onclick="adicionarEntrada()">+ Adicionar Entrada</button>
    </div>

    <table id="tabelaEntradas">
      <thead>
        <tr>
          <th>Data</th><th>Cliente</th><th>Itens</th><th>Instala√ß√£o</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Sa√≠das -->
  <div class="bloco" id="blocoSaidas">
    <h2>Sa√≠das</h2>
    <div class="form-grid">
      <div><label>Data</label><input id="dataSaida" type="date"></div>
      <div><label>Descri√ß√£o</label><input id="descricaoSaida" type="text"></div>
      <div>
        <label>Categoria</label>
        <select id="categoriaSaida">
          <option>Alimenta√ß√£o</option>
          <option>Supermercado</option>
          <option>Transporte</option>
          <option>Compra de Carca√ßa</option>
          <option>Ferramentas</option>
          <option>√ìrg√¥nio/Nitrog√™nio</option>
          <option>Tinta e Tinner</option>
          <option>Disco do Esmeril</option>
          <option>Vareta de Solda</option>
          <option>Pe√ßas</option>
          <option>Outros</option>
        </select>
      </div>
      <div><label>Valor (R$)</label><input id="valorSaida" type="number" step="0.01"></div>
    </div>
    <div class="toolbar">
      <button onclick="adicionarSaida()">+ Adicionar Sa√≠da</button>
    </div>
    <table id="tabelaSaidas">
      <thead>
        <tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Filtros e Resumo -->
  <div class="bloco" id="blocoResumo">
    <h2>Filtros e Resumo</h2>
    <div class="form-grid">
      <div><label>Buscar</label><input id="campoBusca" type="text" placeholder="üîç nome, tipo, forma..." oninput="render()"></div>
      <div><label>Filtro por Dia</label><input id="filtroDia" type="date" onchange="render()"></div>
      <div><label>Filtro por M√™s</label><input id="filtroMes" type="month" onchange="render()"></div>
    </div>
    <div class="summary">
      <div class="pill"><b>Total Entradas</b><span id="totalEntradas" class="ok">R$ 0,00</span></div>
      <div class="pill"><b>Total Sa√≠das</b><span id="totalSaidas" class="bad">R$ 0,00</span></div>
      <div class="pill"><b>Saldo</b><span id="saldo" class="neutral">R$ 0,00</span></div>
      <div class="pill"><b>PIX</b><span id="totalPix">R$ 0,00</span></div>
      <div class="pill"><b>Cart√£o</b><span id="totalCartao">R$ 0,00</span></div>
      <div class="pill"><b>Dinheiro</b><span id="totalDinheiro">R$ 0,00</span></div>
    </div>
  </div>

  <!-- Backup e Relat√≥rios -->
  <div class="bloco" id="blocoRelatorios">
    <h2>Backup e Relat√≥rios</h2>
    <div class="toolbar">
      <button class="secondary" onclick="limparFiltros()">üßπ Limpar Filtros</button>
      <button class="secondary" onclick="exportarCSV()">üìÅ Exportar CSV</button>
      <button class="secondary" onclick="exportarJSON()">üíæ Exportar Backup</button>
      <button class="secondary" id="btnImprimir" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir Relat√≥rio</button>
      <button class="secondary" id="btnFecharMes" onclick="fecharMes()">üìÖ Fechar M√™s</button>
    </div>
  </div>
</div> 
<!-- /app -->

<div id="printArea" style="display:none"></div>

<!-- MODAL DE EDI√á√ÉO DE ENTRADA -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Entrada</h3>
    <div class="form-grid">
      <div><label>Data</label><input id="m_data" type="date"></div>
      <div><label>Cliente</label><input id="m_cliente" type="text"></div>

      <div>
        <label>Tipo</label>
        <select id="m_tipo">
          <option>Dianteiro</option>
          <option>Traseiro</option>
          <option>Dianteiro + Servi√ßo</option>
          <option>Traseiro + Servi√ßo</option>
          <option>Dianteiro + Traseiro</option>
          <option>Dianteiro + Traseiro + Servi√ßo</option>
          <option>Amortecedor Central</option>
          <option>Servi√ßo</option>
          <option>Ferro Velho</option>
          <option>Hastes</option>
          <option>Oficina</option>
        </select>
      </div>

      <div id="m_divServico" style="display:none">
        <label>Descri√ß√£o do Servi√ßo</label>
        <input id="m_descServico" type="text"/>
      </div>

      <div>
        <label>Instala√ß√£o</label>
        <select id="m_instalacao">
          <option>Instalado na Oficina</option>
          <option>Amortecedor Fora</option>
        </select>
      </div>

      <div><label>Qtd</label><input id="m_qtd" type="number" min="1"></div>

      <div>
        <label>Forma de Pagamento</label>
        <select id="m_formaPagamento">
          <option>Pix</option>
          <option>Dinheiro</option>
          <option>Cart√£o</option>
          <option>Combinado</option>
        </select>
      </div>

      <div id="m_boxValorUnico">
        <label>Valor (R$)</label>
        <input id="m_valor" type="number" step="0.01">
      </div>

      <div id="m_boxCombinado" style="display:none;flex-basis:100%">
        <label>Pagamentos</label>
        <div class="pay-row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="pay-item"><span>Pix</span><input id="m_payPixVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
          <div class="pay-item"><span>Dinheiro</span><input id="m_payDinVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
          <div class="pay-item"><span>Cart√£o</span><input id="m_payCartaoVal" type="number" step="0.01" placeholder="0,00" style="width:120px"></div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModal()">Cancelar</button>
      <button onclick="salvarEdicaoEntrada()">Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL DE EDI√á√ÉO DE SA√çDA -->
<div id="modalSaidaBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Editar Sa√≠da</h3>
    <div class="form-grid">
      <div><label>Data</label><input id="m_dataSaida" type="date"></div>
      <div><label>Descri√ß√£o</label><input id="m_descSaida" type="text"></div>
      <div>
        <label>Categoria</label>
        <select id="m_categoriaSaida">
          <option>Alimenta√ß√£o</option>
          <option>Supermercado</option>
          <option>Transporte</option>
          <option>Compra de Carca√ßa</option>
          <option>Ferramentas</option>
          <option>√ìrg√¥nio/Nitrog√™nio</option>
          <option>Tinta e Tinner</option>
          <option>Disco do Esmeril</option>
          <option>Vareta de Solda</option>
          <option>Pe√ßas</option>
          <option>Outros</option>
        </select>
      </div>
      <div><label>Valor (R$)</label><input id="m_valorSaida" type="number" step="0.01"></div>
    </div>
    <div class="actions">
      <button class="secondary" onclick="fecharModalSaida()">Cancelar</button>
      <button onclick="salvarEdicaoSaida()">Salvar</button>
    </div>
  </div>
</div>

<!-- ========================== APP SCRIPT (Firebase Auth + Firestore) ========================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
    onSnapshot, getDocs, query, orderBy, serverTimestamp, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCaaZf78WgruFolJ0FfLKrn7cKjsS00dc0",
    authDomain: "realcar-caixa.firebaseapp.com",
    projectId: "realcar-caixa",
    storageBucket: "realcar-caixa.appspot.com",
    messagingSenderId: "853035037951",
    appId: "1:853035037951:web:5ae763aa016d204acfc8ca"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getFirestore(appFB);
  const auth = getAuth(appFB);

  // ====== Estado ======
  let entradas=[], entradasIDs=[];
  let saidas=[], saidasIDs=[];
  let editIndex = -1;
  let saidaEditIndex = -1;
  let extras = []; // [{tipo,qtd,obs,serv}]
  let role = 'func'; // 'admin' | 'func'
  let today = new Date().toLocaleDateString('fr-CA');

  let unsubEntradas = null;
  let unsubSaidas   = null;

  // ====== Utils ======
  const BRL = v => (parseFloat(v||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const esc = s => String(s??"").replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
  const parseNum = v => parseFloat(String(v??0).replace(',','.'))||0;

  function somaPag(p){ return (parseNum(p?.pix)+parseNum(p?.cartao)+parseNum(p?.dinheiro)); }
  function fmtPag(p){
    const parts=[];
    if(parseNum(p?.pix)>0) parts.push(`Pix ${BRL(p.pix)}`);
    if(parseNum(p?.cartao)>0) parts.push(`Cart√£o ${BRL(p.cartao)}`);
    if(parseNum(p?.dinheiro)>0) parts.push(`Dinheiro ${BRL(p.dinheiro)}`);
    return parts.join(" + ") || "-";
  }

  function allItensFerroHastes(){
    const base = document.getElementById('tipoEntrada').value;
    const isFH = t => (t === 'Ferro Velho' || t === 'Hastes');
    if(!isFH(base)) return false;
    return extras.every(it => isFH(it.tipo));
  }
  function updateInstalacaoVisibility(){
    const box = document.getElementById('instalacaoBox');
    const hide = allItensFerroHastes();
    box.style.display = hide ? 'none':'block';
    if(hide) document.getElementById('instalacaoEntrada').value = '';
  }

  // ====== Auth flow ======
  async function entrar(){
    const email = document.getElementById('email').value.trim();
    const senha = document.getElementById('senha').value.trim();
    const msg=document.getElementById('erroLogin');
    msg.textContent = '';
    try{
      await signInWithEmailAndPassword(auth, email, senha);
      // N√£o chamamos posLogin aqui ‚Äî quem faz isso √© onAuthStateChanged
    }catch(err){
      msg.textContent = 'Falha no login. Verifique e-mail/senha.';
      console.error(err);
    }
  }

  function sair(){
    if (unsubEntradas) { unsubEntradas(); unsubEntradas = null; }
    if (unsubSaidas)   { unsubSaidas();   unsubSaidas = null; }
    signOut(auth).catch(console.error);
  }

  // Enter no login (submit do form)
  document.getElementById('loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    entrar();
  });
  // Bot√£o sair (ligo aqui; vis√≠vel s√≥ quando app aparece)
  document.getElementById('btnSair').addEventListener('click', sair);

  // Liga/Desliga UI baseado no estado da Auth
  onAuthStateChanged(auth, async (user)=>{
    if (user){
      // Papel do Firestore
      try{
        const rdoc = await getDoc(doc(db,'users',user.uid));
        role = (rdoc.exists() && rdoc.data().role) ? rdoc.data().role : 'func';
      }catch(e){ role='func'; }

      posLogin();
    } else {
      // Saiu
      entradas=[]; saidas=[]; entradasIDs=[]; saidasIDs=[];
      extras = [];
      render(); // limpa as tabelas
      document.getElementById('app').style.display='none';
      document.getElementById('loginTela').style.display='flex';
      document.getElementById('erroLogin').textContent='';
      document.getElementById('email').focus();
    }
  });

  function posLogin(){
    document.getElementById('loginTela').style.display='none';
    const appEl=document.getElementById('app');
    appEl.style.display='block';
    appEl.removeAttribute('aria-hidden');
    aplicarPermissoes();
    init();
  }

  function aplicarPermissoes(){
    const who = document.getElementById('whoami');
    who.textContent = role==='admin' ? 'Administrador' : 'Funcion√°rio';

    // Funcion√°rio: bloqueia filtros (apenas dia atual), esconde Fechar M√™s
    const campoBusca = document.getElementById('campoBusca');
    const filtroDia = document.getElementById('filtroDia');
    const filtroMes = document.getElementById('filtroMes');
    filtroDia.value = today;

    if(role !== 'admin'){
      campoBusca.value = '';
      campoBusca.disabled = true;
      filtroMes.value = '';
      filtroMes.disabled = true;
      filtroDia.disabled = true;
      document.getElementById('btnFecharMes').style.display='none';
    }else{
      campoBusca.disabled = false;
      filtroDia.disabled = false;
      filtroMes.disabled = false;
      document.getElementById('btnFecharMes').style.display='';
    }
  }

  // ====== Init ======
  function init(){
    // defaults
    document.getElementById('dataEntrada').value = today;
    document.getElementById('dataSaida').value   = today;
    document.getElementById('filtroDia').value   = today;

    // listeners de UI
    document.getElementById('tipoEntrada').addEventListener('change', () => {
      const t = document.getElementById('tipoEntrada').value;
      document.getElementById('divServico').style.display =
        (t.includes('Servi√ßo') || t === 'Servi√ßo' || t === 'Dianteiro + Traseiro + Servi√ßo') ? 'block':'none';
      updateInstalacaoVisibility();
    });

    document.getElementById('formaPagamento').addEventListener('change', () => {
      const f = document.getElementById('formaPagamento').value;
      document.getElementById('boxCombinado').style.display = (f==="Combinado") ? "block":"none";
      document.getElementById('boxValorUnico').style.display = (f==="Combinado") ? "none":"block";
    });

    // toggle extras
    const extrasBox   = document.getElementById('extrasBox');
    const toggleExtra = document.getElementById('toggleExtras');
    toggleExtra.onclick = ()=>{
      const open = extrasBox.style.display === 'block';
      extrasBox.style.display = open ? 'none' : 'block';
      toggleExtra.textContent = open ? '+ Itens Extras (opcional)' : '‚àí Ocultar Itens Extras';
    };

    // extras listeners
    const exTipo    = document.getElementById('exTipo');
    const exDescBox = document.getElementById('exDescBox');
    exTipo.onchange = ()=>{
      const t = exTipo.value;
      exDescBox.hidden = !(t.includes('Servi√ßo') || t === 'Servi√ßo');
    };
    document.getElementById('btnAddExtra').onclick = addExtra;

    // realtime (desinscreve se j√° tinha)
    if (unsubEntradas) { unsubEntradas(); unsubEntradas = null; }
    if (unsubSaidas)   { unsubSaidas();   unsubSaidas   = null; }

    unsubEntradas = onSnapshot(query(collection(db,'entradas'), orderBy('data','asc')), snap=>{
      entradas = snap.docs.map(d=>d.data());
      entradasIDs = snap.docs.map(d=>d.id);
      render();
    });
    unsubSaidas = onSnapshot(query(collection(db,'saidas'), orderBy('data','asc')), snap=>{
      saidas = snap.docs.map(d=>d.data());
      saidasIDs = snap.docs.map(d=>d.id);
      render();
    });
  }

  // ====== Extras ======
  function renderExtras(){
    const tb = document.querySelector('#tabelaExtras tbody');
    tb.innerHTML = extras.map((it,i)=>{
      const descricao = [
        it.obs  ? `OBS: ${esc(it.obs)}`   : '',
        it.serv ? `SERVI√áO: ${esc(it.serv)}` : ''
      ].filter(Boolean).join(' ‚Äî ');
      return `
        <tr>
          <td>${esc(it.tipo)}</td>
          <td>${it.qtd}</td>
          <td>${descricao || '-'}</td>
          <td class="nowrap">
            ${role==='admin' ? `<button class="danger" type="button" onclick="removerExtra(${i})">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
    }).join('');
    updateInstalacaoVisibility();
  }
  window.removerExtra = (i)=>{ extras.splice(i,1); renderExtras(); };

  function addExtra(){
    const exQtd  = parseInt(document.getElementById('exQtd').value || '1', 10);
    const exTipo = document.getElementById('exTipo').value;
    const exObs  = (document.getElementById('exObs').value || '').trim().toUpperCase();
    const exServ = document.getElementById('exDescBox').hidden ? '' : (document.getElementById('exDesc').value || '').trim().toUpperCase();

    if(exQtd<=0){ alert('Informe uma quantidade v√°lida.'); return; }
    if(!document.getElementById('exDescBox').hidden && !exServ){
      alert('Descreva o servi√ßo.'); return;
    }
    extras.push({ tipo: exTipo, qtd: exQtd, obs: exObs, serv: exServ });
    document.getElementById('exQtd').value = 1;
    document.getElementById('exObs').value = '';
    document.getElementById('exDesc').value = '';
    renderExtras();
  }

  // ====== CRUD Entradas ======
  async function adicionarEntrada(){
    const cliente = (document.getElementById('clienteEntrada').value||'').trim().toUpperCase();
    const data    = document.getElementById('dataEntrada').value || today;
    let instalacao= document.getElementById('instalacaoEntrada').value;
    const tipoSel = document.getElementById('tipoEntrada').value;
    const qtd     = parseInt(document.getElementById('qtdEntrada').value||'1',10);
    const descSrv = (document.getElementById('divServico').style.display==='none') ? '' :
                    (document.getElementById('descricaoServico').value||'').trim().toUpperCase();

    if(!cliente){ alert('Informe o cliente'); return; }
    if(qtd<=0){ alert('Quantidade inv√°lida'); return; }

    // esconder instala√ß√£o se todos forem Ferro/Hastes
    if(allItensFerroHastes()) instalacao = '';

    // pagamento
    const formaSel = document.getElementById('formaPagamento').value;
    let pagamento = { pix:0, dinheiro:0, cartao:0 };
    let total = 0;

    if(formaSel==='Combinado'){
      pagamento.pix      = parseNum(document.getElementById('payPixVal').value);
      pagamento.dinheiro = parseNum(document.getElementById('payDinVal').value);
      pagamento.cartao   = parseNum(document.getElementById('payCartaoVal').value);
      total = somaPag(pagamento);
      if(total<=0){ alert('Informe pelo menos um valor no combinado.'); return; }
    }else{
      total = parseNum(document.getElementById('valorEntrada').value);
      if(total<=0){ alert('Informe um valor v√°lido.'); return; }
      if(formaSel==='Pix') pagamento.pix = total;
      if(formaSel==='Dinheiro') pagamento.dinheiro = total;
      if(formaSel==='Cart√£o') pagamento.cartao = total;
    }

    const nova = {
      data, cliente,
      tipo: tipoSel, qtd, descricao: descSrv,
      extras, // salva array completo
      instalacao,
      pagamento, valor: total,
      forma: (formaSel==='Combinado') ? fmtPag(pagamento) : formaSel,
      createdAt: serverTimestamp()
    };

    await addDoc(collection(db,'entradas'), nova);

    // limpar
    document.getElementById('clienteEntrada').value='';
    document.getElementById('qtdEntrada').value='1';
    document.getElementById('valorEntrada').value='';
    document.getElementById('descricaoServico').value='';
    document.getElementById('divServico').style.display='none';
    document.getElementById('payPixVal').value='';
    document.getElementById('payDinVal').value='';
    document.getElementById('payCartaoVal').value='';
    extras = [];
    renderExtras();
    alert("‚úÖ Entrada adicionada!");
  }
  window.adicionarEntrada = adicionarEntrada;

  function abrirModalEntrada(realIndex){
    const e=entradas[realIndex]; if(!e) return;
    editIndex = realIndex;

    // preencher
    document.getElementById('m_data').value = e.data || today;
    document.getElementById('m_cliente').value = e.cliente || '';
    document.getElementById('m_tipo').value = e.tipo || 'Dianteiro';
    document.getElementById('m_instalacao').value = e.instalacao || '';
    document.getElementById('m_qtd').value = e.qtd || 1;

    const precisaSrv = (e.tipo?.includes('Servi√ßo') || e.tipo==='Servi√ßo' || e.tipo==='Dianteiro + Traseiro + Servi√ßo');
    document.getElementById('m_divServico').style.display = precisaSrv ? 'block':'none';
    document.getElementById('m_descServico').value = e.descricao || '';

    const p = e.pagamento || {pix:0, cartao:0, dinheiro:0};
    const temCombo = [p.pix, p.cartao, p.dinheiro].filter(v=>parseNum(v)>0).length > 1;
    document.getElementById('m_formaPagamento').value = temCombo
      ? 'Combinado'
      : (parseNum(p.pix)>0 ? 'Pix' : parseNum(p.cartao)>0 ? 'Cart√£o' : 'Dinheiro');
    alternarModalPagamentoUI();

    if (document.getElementById('m_formaPagamento').value==='Combinado'){
      document.getElementById('m_payPixVal').value = parseNum(p.pix)||'';
      document.getElementById('m_payDinVal').value = parseNum(p.dinheiro)||'';
      document.getElementById('m_payCartaoVal').value = parseNum(p.cartao)||'';
      document.getElementById('m_valor').value = '';
    } else {
      document.getElementById('m_valor').value = parseNum(e.valor)||0;
      document.getElementById('m_payPixVal').value = '';
      document.getElementById('m_payDinVal').value = '';
      document.getElementById('m_payCartaoVal').value = '';
    }

    document.getElementById('modalBackdrop').style.display='flex';

    document.getElementById('m_tipo').onchange = () => {
      const t = document.getElementById('m_tipo').value;
      document.getElementById('m_divServico').style.display =
        (t.includes('Servi√ßo') || t==='Servi√ßo' || t==='Dianteiro + Traseiro + Servi√ßo') ? 'block':'none';
    };
    document.getElementById('m_formaPagamento').onchange = alternarModalPagamentoUI;
  }
  window.abrirModalEntrada = abrirModalEntrada;

  function alternarModalPagamentoUI(){
    const f = document.getElementById('m_formaPagamento').value;
    document.getElementById('m_boxCombinado').style.display = (f==='Combinado') ? 'block':'none';
    document.getElementById('m_boxValorUnico').style.display = (f==='Combinado') ? 'none':'block';
  }

  function fecharModal(){
    document.getElementById('modalBackdrop').style.display='none';
    editIndex = -1;
  }
  window.fecharModal = fecharModal;

  async function salvarEdicaoEntrada(){
    if(editIndex<0) return;
    const e = entradas[editIndex];
    const id = entradasIDs[editIndex];

    const formaSel = document.getElementById('m_formaPagamento').value;
    let pagamento = {pix:0, cartao:0, dinheiro:0};
    let total = 0;

    if (formaSel==='Combinado'){
      pagamento = {
        pix: parseNum(document.getElementById('m_payPixVal').value),
        dinheiro: parseNum(document.getElementById('m_payDinVal').value),
        cartao: parseNum(document.getElementById('m_payCartaoVal').value),
      };
      total = somaPag(pagamento);
      if (total<=0){ alert('Informe pelo menos um valor no combinado.'); return; }
    } else {
      total = parseNum(document.getElementById('m_valor').value);
      if (total<=0){ alert('Informe um valor v√°lido.'); return; }
      if (formaSel==='Pix') pagamento.pix = total;
      if (formaSel==='Dinheiro') pagamento.dinheiro = total;
      if (formaSel==='Cart√£o') pagamento.cartao = total;
    }

    const novo = {
      ...e,
      data: document.getElementById('m_data').value || today,
      cliente: (document.getElementById('m_cliente').value||'').trim().toUpperCase(),
      tipo: document.getElementById('m_tipo').value,
      instalacao: document.getElementById('m_instalacao').value,
      qtd: parseInt(document.getElementById('m_qtd').value||'1',10),
      valor: total,
      pagamento,
      forma: (formaSel==='Combinado') ? fmtPag(pagamento) : formaSel,
    };

    const t = novo.tipo;
    if (t.includes('Servi√ßo') || t === 'Servi√ßo' || t === 'Dianteiro + Traseiro + Servi√ßo'){
      novo.descricao = (document.getElementById('m_descServico').value||'').trim().toUpperCase();
    } else {
      novo.descricao = '';
    }

    await updateDoc(doc(db,'entradas', id), novo);
    fecharModal();
  }
  window.salvarEdicaoEntrada = salvarEdicaoEntrada;

  async function excluirEntrada(realIndex){
    if(role!=='admin'){ return alert('Sem permiss√£o para excluir.'); }
    if(!confirm('Excluir esta entrada?')) return;
    await deleteDoc(doc(db,'entradas', entradasIDs[realIndex]));
  }
  window.excluirEntrada=excluirEntrada;

  // ====== CRUD Sa√≠das ======
  async function adicionarSaida(){
    const nova = {
      data: document.getElementById('dataSaida').value || today,
      descricao: (document.getElementById('descricaoSaida').value || '').trim().toUpperCase(),
      categoria: document.getElementById('categoriaSaida').value,
      valor: parseNum(document.getElementById('valorSaida').value),
      createdAt: serverTimestamp()
    };
    if(!nova.descricao || nova.valor<=0){ alert('Preencha descri√ß√£o e valor v√°lido.'); return; }
    await addDoc(collection(db,'saidas'), nova);
    document.getElementById('descricaoSaida').value='';
    document.getElementById('valorSaida').value='';
    alert("‚úÖ Sa√≠da adicionada!");
  }
  window.adicionarSaida = adicionarSaida;

  function editarSaida(idx){
    const s = saidas[idx]; if(!s) return;
    saidaEditIndex = idx;
    document.getElementById('m_dataSaida').value = s.data || today;
    document.getElementById('m_descSaida').value = s.descricao || '';
    document.getElementById('m_categoriaSaida').value = s.categoria || 'Outros';
    document.getElementById('m_valorSaida').value = parseNum(s.valor||0);
    document.getElementById('modalSaidaBackdrop').style.display='flex';
  }
  window.editarSaida = editarSaida;

  function fecharModalSaida(){
    document.getElementById('modalSaidaBackdrop').style.display='none';
    saidaEditIndex = -1;
  }
  window.fecharModalSaida = fecharModalSaida;

  async function salvarEdicaoSaida(){
    if(saidaEditIndex<0) return;
    const novo = {
      ...saidas[saidaEditIndex],
      data: document.getElementById('m_dataSaida').value || today,
      descricao: (document.getElementById('m_descSaida').value||'').trim().toUpperCase(),
      categoria: document.getElementById('m_categoriaSaida').value,
      valor: parseNum(document.getElementById('m_valorSaida').value)
    };
    if(!novo.descricao || novo.valor<=0){ alert('Preencha descri√ß√£o e valor v√°lido.'); return; }
    await updateDoc(doc(db,'saidas', saidasIDs[saidaEditIndex]), novo);
    fecharModalSaida();
  }
  window.salvarEdicaoSaida = salvarEdicaoSaida;

  async function excluirSaida(idx){
    if(role!=='admin'){ return alert('Sem permiss√£o para excluir.'); }
    if(!confirm('Excluir esta sa√≠da?')) return;
    await deleteDoc(doc(db,'saidas', saidasIDs[idx]));
  }
  window.excluirSaida = excluirSaida;

  // ====== Filtros/Busca/Render ======
  function filtroAtivo(dataISO){
    const dia=document.getElementById('filtroDia').value;
    const mes=document.getElementById('filtroMes').value;
    if(role!=='admin') return (dataISO||'')===today; // funcion√°rio: sempre hoje
    if(dia) return (dataISO||'')===dia;
    if(mes) return (dataISO||'').startsWith(mes);
    return true;
  }

  function render(){
    const busca=(document.getElementById('campoBusca').value||'').toLowerCase();

    // Entradas
    const ent = entradas.map((e,idx)=>({e,idx}))
      .filter(o=>filtroAtivo(o.e.data))
      .filter(o=>{
        if(role!=='admin'){ return true; } // sem busca pra func (campo desativado)
        const txt = (o.e.cliente + JSON.stringify(o.e.extras||[]) + (o.e.forma||'') + (o.e.instalacao||'') + (o.e.tipo||'') + (o.e.descricao||'')).toLowerCase();
        return !busca || txt.includes(busca);
      });

    const te=document.querySelector('#tabelaEntradas tbody');
    te.innerHTML = ent.map(o=>{
      const base = `${o.e.qtd||1}x ${esc(o.e.tipo||'-')}${o.e.descricao? ' - '+esc(o.e.descricao):''}`;
      const ex = (o.e.extras||[]).map(it=>`${it.qtd}x ${esc(it.tipo)}${it.serv? ' - '+esc(it.serv):''}${it.obs? ' (OBS: '+esc(it.obs)+')':''}`).join('<br>');
      return `
      <tr>
        <td>${esc(o.e.data||'')}</td>
        <td>${esc(o.e.cliente||'')}</td>
        <td>${base}${ex? '<br>'+ex:''}</td>
        <td>${esc(o.e.instalacao||'-')}</td>
        <td>${esc(o.e.forma || fmtPag(o.e.pagamento||{}))}</td>
        <td>${BRL(o.e.valor||0)}</td>
        <td class="nowrap">
          <button class="secondary" onclick="abrirModalEntrada(${o.idx})">‚úèÔ∏è</button>
          ${role==='admin' ? `<button class="danger" onclick="excluirEntrada(${o.idx})">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
    }).join('');

    // Sa√≠das
    const sai = saidas.map((s,idx)=>({s,idx}))
      .filter(o=>filtroAtivo(o.s.data))
      .filter(o=>{
        if(role!=='admin') return true;
        const txt=(o.s.descricao + o.s.categoria).toLowerCase();
        return !busca || txt.includes(busca);
      });

    const ts=document.querySelector('#tabelaSaidas tbody');
    ts.innerHTML=sai.map(o=>`
      <tr>
        <td>${esc(o.s.data||'')}</td>
        <td>${esc(o.s.descricao||'')}</td>
        <td>${esc(o.s.categoria||'')}</td>
        <td>${BRL(o.s.valor||0)}</td>
        <td class="nowrap">
          <button class="secondary" onclick="editarSaida(${o.idx})">‚úèÔ∏è</button>
          ${role==='admin' ? `<button class="danger" onclick="excluirSaida(${o.idx})">üóëÔ∏è</button>` : ''}
        </td>
      </tr>
    `).join('');

    // Totais
    const totE=ent.reduce((acc,o)=>acc+(parseNum(o.e.valor)||0),0);
    const totS=sai.reduce((acc,o)=>acc+(parseNum(o.s.valor)||0),0);
    document.getElementById('totalEntradas').textContent=BRL(totE);
    document.getElementById('totalSaidas').textContent=BRL(totS);
    const saldoEl=document.getElementById('saldo');
    saldoEl.textContent=BRL(totE-totS);
    saldoEl.style.color=(totE-totS)>=0? 'var(--ok)' : 'var(--bad)';

    const pix=ent.reduce((s,o)=>s+parseNum(o.e?.pagamento?.pix),0);
    const cartao=ent.reduce((s,o)=>s+parseNum(o.e?.pagamento?.cartao),0);
    const dinheiro=ent.reduce((s,o)=>s+parseNum(o.e?.pagamento?.dinheiro),0);
    document.getElementById('totalPix').textContent=BRL(pix);
    document.getElementById('totalCartao').textContent=BRL(cartao);
    document.getElementById('totalDinheiro').textContent=BRL(dinheiro);
  }
  window.render=render;

  function limparFiltros(){
    if(role!=='admin'){
      document.getElementById('filtroDia').value=today;
      render(); return;
    }
    document.getElementById('campoBusca').value='';
    document.getElementById('filtroDia').value=today;
    document.getElementById('filtroMes').value='';
    render();
  }
  window.limparFiltros=limparFiltros;

  // ====== CSV / Backup ======
  function csvEsc(s){ if(s==null) return ''; s=String(s); return /[,\";\n]/.test(s)? `\"${s.replace(/\"/g,'\"\"')}\"` : s; }

  async function exportarCSV(){
    const eSnap=await getDocs(collection(db,'entradas'));
    const sSnap=await getDocs(collection(db,'saidas'));
    const ent = eSnap.docs.map(d=>d.data());
    const sai = sSnap.docs.map(d=>d.data());

    let csv='Tipo,Data,Cliente,Itens,Instala√ß√£o,Pagamento,Valor\n';
    ent.forEach(e=>{
      const base = `${e.qtd||1}x ${e.tipo||''}${e.descricao? ' - '+e.descricao:''}`;
      const itensTxt = [base, ...(e.extras||[]).map(it=>`${it.qtd}x ${it.tipo}${it.serv? ' - '+it.serv:''}${it.obs? ' (OBS: '+it.obs+')':''}`)].join(' | ');
      csv+=`Entrada,${e.data||''},${csvEsc(e.cliente||'')},${csvEsc(itensTxt)},${csvEsc(e.instalacao||'')},${csvEsc(e.forma || fmtPag(e.pagamento||{}))},${e.valor||0}\n`;
    });
    sai.forEach(s=>{
      csv+=`Sa√≠da,${s.data||''},${csvEsc(s.descricao||'')},${csvEsc(s.categoria||'')},,,${s.valor||0}\n`;
    });

    const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='realcar_caixa.csv';
    a.click(); URL.revokeObjectURL(a.href);
  }
  window.exportarCSV=exportarCSV;

  async function exportarJSON(){
    const eSnap=await getDocs(collection(db,'entradas'));
    const sSnap=await getDocs(collection(db,'saidas'));
    const data={ entradas:eSnap.docs.map(d=>({id:d.id,...d.data()})),
                 saidas:sSnap.docs.map(d=>({id:d.id,...d.data()})) };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='realcar_backup.json'; a.click();
  }
  window.exportarJSON=exportarJSON;

  // ====== Relat√≥rios ======
  function imprimirRelatorio(){
    const dia=(role==='admin' ? document.getElementById('filtroDia').value : today);
    const mes=(role==='admin' ? document.getElementById('filtroMes').value : '');
    const busca=(role==='admin' ? (document.getElementById('campoBusca').value||'') : '');
    const filtra = d => (dia? d===dia : (mes? (d||'').startsWith(mes) : true));

    const ent=entradas.filter(e=>filtra(e.data)&&(!busca || (e.cliente + JSON.stringify(e.extras||[]) + (e.tipo||'') + (e.descricao||'')).toLowerCase().includes(busca.toLowerCase())));
    const sai=saidas.filter(s=>filtra(s.data)&&(!busca || (s.descricao + s.categoria).toLowerCase().includes(busca.toLowerCase())));

    const totE=ent.reduce((a,e)=>a+(parseNum(e.valor)||0),0);
    const totS=sai.reduce((a,e)=>a+(parseNum(e.valor)||0),0);

    const area=document.getElementById('printArea');
    const titulo= dia? `Relat√≥rio do dia ${dia}` : (mes? `Relat√≥rio do m√™s ${mes}` : 'Relat√≥rio geral');
    area.innerHTML=`
      <div style="font-family:Arial;color:#000;width:720px;margin:auto">
        <h2 style="margin:6px 0">üìÑ ${titulo} ‚Äì Real Car Amortecedores</h2><hr/>
        <h3>Entradas</h3>
        <ul>${
          ent.map(e=>{
            const base = `${e.qtd||1}x ${esc(e.tipo||'-')}${e.descricao? ' - '+esc(e.descricao):''}`;
            const ex = (e.extras||[]).map(it=>`${it.qtd}x ${esc(it.tipo)}${it.serv? ' - '+esc(it.serv):''}${it.obs? ' (OBS: '+esc(it.obs)+')':''}`).join(' | ');
            const itens = base + (ex? ' | '+ex:'');
            return `<li>${e.data} ‚Äì ${esc(e.cliente)} (${itens}, ${esc(e.instalacao||'-')}, ${esc(e.forma || fmtPag(e.pagamento||{}))}) ‚Äì ${BRL(e.valor)}</li>`
          }).join('')
        }</ul>
        <h3>Sa√≠das</h3>
        <ul>${
          sai.map(s=>`<li>${s.data} ‚Äì ${esc(s.descricao)} (${esc(s.categoria)}) ‚Äì ${BRL(s.valor)}</li>`).join('')
        }</ul>
        <hr/><p><b>Total Entradas:</b> ${BRL(totE)}<br><b>Total Sa√≠das:</b> ${BRL(totS)}<br><b>Saldo:</b> ${BRL(totE-totS)}</p>
      </div>`;
    setTimeout(()=>window.print(),100);
  }
  window.imprimirRelatorio=imprimirRelatorio;

  function fecharMes(){
    if(role!=='admin') return;
    const mes=document.getElementById('filtroMes').value || new Date().toISOString().slice(0,7);
    const ent=entradas.filter(e=>String(e.data||'').startsWith(mes));
    const sai=saidas.filter(s=>String(s.data||'').startsWith(mes));
    const totE=ent.reduce((a,e)=>a+(parseNum(e.valor)||0),0);
    const totS=sai.reduce((a,e)=>a+(parseNum(e.valor)||0),0);
    alert(`üìÖ Fechamento ${mes}\nEntradas: ${BRL(totE)}\nSa√≠das: ${BRL(totS)}\nSaldo: ${BRL(totE-totS)}`);
  }
  window.fecharMes=fecharMes;

</script>

</body>
</html>
